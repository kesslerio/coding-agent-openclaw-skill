# Tooling and Timeouts

## Approach Comparison

| Method | Reliability | Output | Best For |
|--------|-------------|--------|----------|
| tmux + Codex CLI | ✅ High | Full TTY + logs | Long/complex tasks, reviews |
| Codex CLI (direct) | ⚠️ Medium | Text stream | Short, non-interactive runs |
| Claude CLI | ⚠️ Medium | Text stream | Fallback when Codex is unavailable |

## Wrapper Scripts (Recommended)

The wrapper scripts run Codex inside tmux and emit monitoring info. They start a tmux session and return immediately (non-blocking) unless `CODEX_TMUX_WAIT=1` is set.

```bash
# Review (5 min timeout, tmux)
"${CODING_AGENT_DIR:-./}/scripts/code-review" "Review PR #123 for bugs, security, quality"

# Implementation (3 min timeout, tmux)
"${CODING_AGENT_DIR:-./}/scripts/code-implement" "Implement feature X in /path/to/repo"
```

## tmux Conventions (OpenClaw)

- Socket directory: `OPENCLAW_TMUX_SOCKET_DIR` (legacy: `CLAWDBOT_TMUX_SOCKET_DIR`)
- Default socket: `${TMPDIR:-/tmp}/openclaw-tmux-sockets/openclaw.sock`
- Send commands literally: `tmux ... send-keys -l -- "cmd"`
- Always print monitor commands after creating a session

## Direct tmux Usage

```bash
SOCKET_DIR="${OPENCLAW_TMUX_SOCKET_DIR:-${CLAWDBOT_TMUX_SOCKET_DIR:-${TMPDIR:-/tmp}/openclaw-tmux-sockets}}"
mkdir -p "$SOCKET_DIR"
SOCKET="$SOCKET_DIR/openclaw.sock"
SESSION="codex-review-$(date +%Y%m%d-%H%M%S)"

# Start session and run codex
tmux -S "$SOCKET" new-session -d -s "$SESSION" -n shell
tmux -S "$SOCKET" send-keys -t "$SESSION":0.0 -l -- "codex review --base main" Enter

# Monitor
tmux -S "$SOCKET" attach -t "$SESSION"
tmux -S "$SOCKET" capture-pane -p -J -t "$SESSION":0.0 -S -200
```

## tmux-run Helper

`scripts/tmux-run` standardizes sockets, logging, and session names. It is non-blocking by default.

```bash
# Run an implementation command in tmux (non-blocking)
CODEX_TMUX_SESSION_PREFIX=codex-impl \
  ./scripts/tmux-run timeout 180s codex --yolo exec "Implement feature X"

# Run a review in tmux and wait for completion
CODEX_TMUX_SESSION_PREFIX=codex-review \
  ./scripts/tmux-run --wait timeout 300s codex review --base main --title "PR Review"
```

Logs are stored in:
- `${XDG_STATE_HOME:-$HOME/.local/state}/openclaw/tmux/<session>.log`

Cleanup suggestions:
- Kill a single session: `tmux -S "$SOCKET" kill-session -t "$SESSION"`
- Remove old logs: `find "$LOG_DIR" -type f -mtime +7 -delete`

If you have the OpenClaw tmux skill installed, use its helper:
- `{baseDir}/scripts/wait-for-text.sh` to wait for prompts or DONE markers

## CLI Direct (Only If tmux Unavailable)

```bash
# Implementation (full autonomy)
timeout 180s codex --yolo exec "Implement feature X. No questions."

# Review (purpose-built command)
codex review --base main --title "PR Review"
```

## Minimum Timeouts

| Task Type | Minimum | Recommended |
|-----------|---------|-------------|
| Code review | 180s | 300s |
| Architectural review | 300s | 600s |
| Single-file implementation | 120s | 180s |
| Multi-file implementation | 300s | 600s |

## Environment Variables

| Variable | Purpose | Default |
|----------|---------|---------|
| `OPENCLAW_TMUX_SOCKET_DIR` | Socket directory (preferred) | `${TMPDIR:-/tmp}/openclaw-tmux-sockets` |
| `CLAWDBOT_TMUX_SOCKET_DIR` | Legacy socket directory | unset |
| `CODEX_TMUX_SOCKET_DIR` | Explicit socket directory override | unset |
| `CODEX_TMUX_SOCKET` | Explicit socket path | `${OPENCLAW_TMUX_SOCKET_DIR}/openclaw.sock` |
| `CODEX_TMUX_SESSION` | Explicit session name | autogenerated |
| `CODEX_TMUX_SESSION_PREFIX` | Session name prefix | `codex` |
| `CODEX_TMUX_LOG_DIR` | Log directory | `${XDG_STATE_HOME:-$HOME/.local/state}/openclaw/tmux` |
| `CODEX_TMUX_WAIT` | Block until command finishes | `0` |
| `CODEX_TMUX_CLEANUP` | Kill session after completion | `0` |
| `CODEX_TMUX_WAIT_TIMEOUT` | Optional wait timeout (seconds) | unset |
| `CODEX_TMUX_DISABLE` | Disable tmux and run direct CLI | `0` |
| `CODEX_TMUX_REQUIRED` | Require tmux for Codex (safe-fallback) | `1` |
| `CODE_REVIEW_TIMEOUT` | Review wrapper timeout (ms) | `300000` |
| `CODE_IMPLEMENT_TIMEOUT` | Implement wrapper timeout (ms) | `180000` |
