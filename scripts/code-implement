#!/usr/bin/env bash
# code-implement - Wrapper for code implementation with proper timeout
# Usage: code-implement "Implement feature X in /path/to/repo"
#
# Default timeout: 3 minutes (180000ms for MCP, 180s for CLI)
# Override with CODE_IMPLEMENT_TIMEOUT env var
#
# Strategy (in order of preference):
# 1. MCP with MCPORTER_DEBUG_HANG=1 (fixes known hanging issues)
# 2. Fallback to codex --yolo exec (reliable, no MCP)

set -euo pipefail

if [[ $# -lt 1 ]]; then
    echo "Usage: code-implement \"<prompt>\"" >&2
    echo "Example: code-implement \"Implement auth middleware in /home/art/project\"" >&2
    exit 1
fi

TIMEOUT_MS="${CODE_IMPLEMENT_TIMEOUT:-180000}"
TIMEOUT_SEC=$((TIMEOUT_MS / 1000))

# Ensure standard tools are available on NixOS
export PATH="$PATH:/run/current-system/sw/bin"

# Fix for Codex MCP hanging issues (GitHub #6664, #6127)
export MCPORTER_DEBUG_HANG=1
export MCPORTER_CALL_TIMEOUT="$TIMEOUT_MS"

echo "Starting implementation with ${TIMEOUT_SEC}s timeout..." >&2

# Try MCP first (structured output, better integration)
if mcporter call codex.codex \
    "prompt=$*" \
    'sandbox=workspace-write' \
    'approval-policy=on-failure' \
    --timeout "$TIMEOUT_MS" 2>&1; then
    exit 0
fi

echo "MCP failed, falling back to codex CLI..." >&2

# Fallback: direct CLI (more reliable for long tasks)
timeout "${TIMEOUT_SEC}s" codex --yolo exec "$*"
