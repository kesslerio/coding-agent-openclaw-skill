#!/usr/bin/env bash
# code-implement - Wrapper for code implementation with proper timeout
# Usage: code-implement "Implement feature X in /path/to/repo"
#
# Default timeout: 3 minutes (180s)
# Override with CODE_IMPLEMENT_TIMEOUT env var
#
# Strategy (in order of preference):
# 1. codex --yolo exec in tmux (recommended)
# 2. Manual intervention if tmux/codex unavailable

set -euo pipefail

# Ensure standard tools are available on NixOS
export PATH="$PATH:/run/current-system/sw/bin"

if [[ $# -lt 1 ]]; then
    echo "Usage: code-implement \"<prompt>\"" >&2
    echo "Example: code-implement \"Implement user auth in /path/to/project\"" >&2
    exit 1
fi

TIMEOUT_MS="${CODE_IMPLEMENT_TIMEOUT:-180000}"

# [P1] Validate timeout is numeric
if [[ ! "$TIMEOUT_MS" =~ ^[0-9]+$ ]]; then
    echo "Error: CODE_IMPLEMENT_TIMEOUT must be a number (milliseconds)" >&2
    echo "Got: $TIMEOUT_MS" >&2
    exit 1
fi

TIMEOUT_SEC=$((TIMEOUT_MS / 1000))

echo "Starting implementation in tmux with ${TIMEOUT_SEC}s timeout..." >&2

if ! command -v codex &> /dev/null; then
    echo "Error: codex CLI not found. Please install: npm install -g @openai/codex" >&2
    exit 1
fi

if ! command -v tmux &> /dev/null; then
    echo "Error: tmux not found. Install tmux or use a host with tmux available." >&2
    exit 1
fi

if ! command -v timeout &> /dev/null; then
    echo "Error: timeout command not found. Install coreutils (brew install coreutils on macOS)." >&2
    exit 1
fi

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
TMUX_RUN="$SCRIPT_DIR/tmux-run"
if [[ ! -x "$TMUX_RUN" ]]; then
    echo "Error: tmux-run not found or not executable: $TMUX_RUN" >&2
    exit 1
fi

CODEX_TMUX_SESSION_PREFIX="${CODEX_TMUX_SESSION_PREFIX:-codex-impl}" \
  "$TMUX_RUN" timeout "${TIMEOUT_SEC}s" codex --yolo exec "$@"
