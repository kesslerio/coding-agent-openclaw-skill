#!/usr/bin/env bash
# code-review - Wrapper for code reviews with proper timeout
# Usage: code-review "Review PR #123 for bugs, security, quality"
#
# Default timeout: 5 minutes (300s)
# Override with CODE_REVIEW_TIMEOUT env var
#
# Strategy (in order of preference):
# 1. codex review in tmux (recommended)
# 2. Manual intervention if tmux/codex unavailable

set -euo pipefail

# Ensure standard tools are available on NixOS
export PATH="$PATH:/run/current-system/sw/bin"

if [[ $# -lt 1 ]]; then
    echo "Usage: code-review \"<prompt>\"" >&2
    echo "Example: code-review \"Review PR #123 for bugs, security, code quality\"" >&2
    exit 1
fi

TIMEOUT_MS="${CODE_REVIEW_TIMEOUT:-300000}"

# [P1] Validate timeout is numeric
if [[ ! "$TIMEOUT_MS" =~ ^[0-9]+$ ]]; then
    echo "Error: CODE_REVIEW_TIMEOUT must be a number (milliseconds)" >&2
    echo "Got: $TIMEOUT_MS" >&2
    exit 1
fi

TIMEOUT_SEC=$((TIMEOUT_MS / 1000))

echo "Starting code review in tmux with ${TIMEOUT_SEC}s timeout..." >&2

if ! command -v codex &> /dev/null; then
    echo "Error: codex CLI not found. Please install: npm install -g @openai/codex" >&2
    exit 1
fi

if ! command -v tmux &> /dev/null; then
    echo "Error: tmux not found. Install tmux or use a host with tmux available." >&2
    exit 1
fi

if ! command -v timeout &> /dev/null; then
    echo "Error: timeout command not found. Install coreutils (brew install coreutils on macOS)." >&2
    exit 1
fi

# Auto-detect default branch (main or master)
DEFAULT_BRANCH="main"
if git rev-parse --abbrev-ref origin/HEAD &> /dev/null; then
    DEFAULT_BRANCH=$(git rev-parse --abbrev-ref origin/HEAD | sed 's/origin\///')
elif git show-ref --verify --quiet refs/heads/master; then
    DEFAULT_BRANCH="master"
fi

REVIEW_TITLE="${*:0:100}"

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
TMUX_RUN="$SCRIPT_DIR/tmux-run"
if [[ ! -x "$TMUX_RUN" ]]; then
    echo "Error: tmux-run not found or not executable: $TMUX_RUN" >&2
    exit 1
fi

CODEX_TMUX_SESSION_PREFIX="${CODEX_TMUX_SESSION_PREFIX:-codex-review}" \
  "$TMUX_RUN" timeout "${TIMEOUT_SEC}s" codex review --base "$DEFAULT_BRANCH" --title "$REVIEW_TITLE"
