#!/usr/bin/env bash
# code-review - Wrapper for code reviews with proper timeout
# Usage: code-review [options] "Review PR #123 for bugs, security, quality"
#
# Default timeout: 10 minutes (600s)
# Override with:
#   --timeout <seconds>
#   CODE_REVIEW_TIMEOUT_SEC (seconds)
#   CODE_REVIEW_TIMEOUT (milliseconds)
#
# Strategy (in order of preference):
# 1. codex review in tmux (recommended)
# 2. Manual intervention if tmux/codex unavailable

set -euo pipefail

# Ensure standard tools are available on NixOS
export PATH="$PATH:/run/current-system/sw/bin"

usage() {
    cat >&2 <<'EOF'
Usage: code-review [options] "<review title/instructions>"

Options:
  --timeout <seconds>               Review timeout in seconds (default: 600)
  --reasoning-effort <level>        none|minimal|low|medium|high|xhigh
  --auto-reasoning-threshold <n>    Auto-set medium effort when changed lines > n (default: 500)
  -h, --help                        Show this help

Environment overrides:
  CODE_REVIEW_TIMEOUT_SEC           Timeout in seconds
  CODE_REVIEW_TIMEOUT               Timeout in milliseconds (legacy)
  CODE_REVIEW_REASONING_EFFORT      Reasoning effort override
  CODE_REVIEW_DIFF_THRESHOLD        Auto-threshold for changed lines

Notes:
  Codex v0.100.0 rejects [PROMPT] when --base is provided for `codex review`.
  This wrapper intentionally passes no positional prompt, uses your text for
  --title/context, and runs review against --base.
EOF
}

validate_reasoning_effort() {
    case "$1" in
        none|minimal|low|medium|high|xhigh) return 0 ;;
        *) return 1 ;;
    esac
}

TIMEOUT_OVERRIDE=""
REASONING_OVERRIDE=""
THRESHOLD_OVERRIDE=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --timeout)
            if [[ $# -lt 2 ]]; then
                echo "Error: --timeout requires a value in seconds" >&2
                usage
                exit 1
            fi
            TIMEOUT_OVERRIDE="$2"
            shift 2
            ;;
        --timeout=*)
            TIMEOUT_OVERRIDE="${1#*=}"
            shift
            ;;
        --reasoning-effort)
            if [[ $# -lt 2 ]]; then
                echo "Error: --reasoning-effort requires a value" >&2
                usage
                exit 1
            fi
            REASONING_OVERRIDE="$2"
            shift 2
            ;;
        --reasoning-effort=*)
            REASONING_OVERRIDE="${1#*=}"
            shift
            ;;
        --auto-reasoning-threshold)
            if [[ $# -lt 2 ]]; then
                echo "Error: --auto-reasoning-threshold requires a numeric value" >&2
                usage
                exit 1
            fi
            THRESHOLD_OVERRIDE="$2"
            shift 2
            ;;
        --auto-reasoning-threshold=*)
            THRESHOLD_OVERRIDE="${1#*=}"
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        --)
            shift
            break
            ;;
        -*)
            echo "Error: unknown option: $1" >&2
            usage
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

if [[ $# -lt 1 ]]; then
    echo "Error: missing review prompt" >&2
    usage
    exit 1
fi

REVIEW_PROMPT="$*"

DEFAULT_TIMEOUT_SEC=600
TIMEOUT_SEC="$DEFAULT_TIMEOUT_SEC"
if [[ -n "$TIMEOUT_OVERRIDE" ]]; then
    TIMEOUT_SEC="$TIMEOUT_OVERRIDE"
elif [[ -n "${CODE_REVIEW_TIMEOUT_SEC:-}" ]]; then
    TIMEOUT_SEC="${CODE_REVIEW_TIMEOUT_SEC}"
else
    TIMEOUT_MS="${CODE_REVIEW_TIMEOUT:-600000}"
    if [[ ! "$TIMEOUT_MS" =~ ^[0-9]+$ ]]; then
        echo "Error: CODE_REVIEW_TIMEOUT must be numeric milliseconds" >&2
        echo "Got: $TIMEOUT_MS" >&2
        exit 1
    fi
    TIMEOUT_SEC=$((TIMEOUT_MS / 1000))
fi

if [[ ! "$TIMEOUT_SEC" =~ ^[0-9]+$ ]] || [[ "$TIMEOUT_SEC" -lt 1 ]]; then
    echo "Error: timeout must be a positive integer in seconds" >&2
    echo "Got: $TIMEOUT_SEC" >&2
    exit 1
fi

AUTO_REASONING_THRESHOLD="${THRESHOLD_OVERRIDE:-${CODE_REVIEW_DIFF_THRESHOLD:-500}}"
if [[ ! "$AUTO_REASONING_THRESHOLD" =~ ^[0-9]+$ ]]; then
    echo "Error: auto reasoning threshold must be numeric" >&2
    echo "Got: $AUTO_REASONING_THRESHOLD" >&2
    exit 1
fi

if ! command -v codex &> /dev/null; then
    echo "Error: codex CLI not found. Please install: npm install -g @openai/codex" >&2
    exit 1
fi

if ! command -v tmux &> /dev/null; then
    echo "Error: tmux not found. Install tmux or use a host with tmux available." >&2
    exit 1
fi

if ! command -v timeout &> /dev/null; then
    echo "Error: timeout command not found. Install coreutils (brew install coreutils on macOS)." >&2
    exit 1
fi

# Auto-detect default branch (main or master)
DEFAULT_BRANCH="main"
if git rev-parse --abbrev-ref origin/HEAD &> /dev/null; then
    DEFAULT_BRANCH=$(git rev-parse --abbrev-ref origin/HEAD | sed 's/origin\///')
elif git show-ref --verify --quiet refs/heads/master; then
    DEFAULT_BRANCH="master"
fi

SELECTED_REASONING="${REASONING_OVERRIDE:-${CODE_REVIEW_REASONING_EFFORT:-}}"
if [[ -n "$SELECTED_REASONING" ]] && ! validate_reasoning_effort "$SELECTED_REASONING"; then
    echo "Error: invalid reasoning effort: $SELECTED_REASONING" >&2
    echo "Allowed: none|minimal|low|medium|high|xhigh" >&2
    exit 1
fi

# Resolve base ref (local branch or remote-tracking)
DIFF_BASE="$DEFAULT_BRANCH"
if ! git rev-parse --verify "$DIFF_BASE" &> /dev/null && git rev-parse --verify "origin/$DIFF_BASE" &> /dev/null; then
    DIFF_BASE="origin/$DIFF_BASE"
fi

CHANGED_LINES=0
if [[ -z "$SELECTED_REASONING" ]] && git rev-parse --verify "$DIFF_BASE" &> /dev/null; then
    while IFS=$'\t' read -r added deleted _rest; do
        if [[ "$added" == "-" || "$deleted" == "-" ]]; then
            continue
        fi
        CHANGED_LINES=$((CHANGED_LINES + added + deleted))
    done < <(git diff --numstat "$DIFF_BASE"...HEAD)

    if [[ "$CHANGED_LINES" -gt "$AUTO_REASONING_THRESHOLD" ]]; then
        SELECTED_REASONING="medium"
    fi
fi

echo "Starting code review in tmux with ${TIMEOUT_SEC}s timeout (base: ${DEFAULT_BRANCH})..." >&2
if [[ "$CHANGED_LINES" -gt 0 ]]; then
    echo "Diff size vs ${DEFAULT_BRANCH}: ${CHANGED_LINES} changed lines (threshold: ${AUTO_REASONING_THRESHOLD})" >&2
fi
if [[ -n "$SELECTED_REASONING" ]]; then
    echo "Using reasoning effort: ${SELECTED_REASONING}" >&2
fi

REVIEW_TITLE="${REVIEW_PROMPT:0:100}"

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
TMUX_RUN="$SCRIPT_DIR/tmux-run"
if [[ ! -x "$TMUX_RUN" ]]; then
    echo "Error: tmux-run not found or not executable: $TMUX_RUN" >&2
    exit 1
fi

# Codex v0.100.0 parser currently rejects:
#   codex review --base <branch> [PROMPT]
# Keep --base and pass context through --title for compatibility.
CODEX_ARGS=(review --base "$DIFF_BASE" --title "$REVIEW_TITLE")
if [[ -n "$SELECTED_REASONING" ]]; then
    CODEX_ARGS=(-c "model_reasoning_effort=\"$SELECTED_REASONING\"" "${CODEX_ARGS[@]}")
fi

CODEX_TMUX_SESSION_PREFIX="${CODEX_TMUX_SESSION_PREFIX:-codex-review}" \
  "$TMUX_RUN" --wait --cleanup timeout "${TIMEOUT_SEC}s" codex "${CODEX_ARGS[@]}"
